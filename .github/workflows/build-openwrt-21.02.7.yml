name: Build OpenWrt 21.02.7 Package

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-openwrt-21-02-7:
    runs-on: ubuntu-latest
    container:
      image: debian:11
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install build dependencies
      run: |
        apt-get update
        apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync wget ca-certificates
    
    - name: Set SDK filename variable
      run: |
        echo "SDK_FILENAME=openwrt-sdk-21.02.7-ramips-mt7621_gcc-8.4.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
    
    - name: Check if SDK exists and download if needed
      run: |
        if [[ -f "$SDK_FILENAME" ]]; then
          echo "Had $SDK_FILENAME, skip download"
        else
          echo "No $SDK_FILENAME, Downloading"
          wget "https://mirrors.sustech.edu.cn/openwrt/releases/21.02.7/targets/ramips/mt7621/openwrt-sdk-21.02.7-ramips-mt7621_gcc-8.4.0_musl.Linux-x86_64.tar.xz"
        fi
    
    - name: Remove existing openwrt-sdk directory
      run: |
        echo "Remove openwrt-sdk dir(if had)"
        rm -rf openwrt-sdk
    
    - name: Extract SDK
      run: |
        echo "Extracting SDK"
        tar -xf openwrt-sdk-21.02.7-ramips-mt7621_gcc-8.4.0_musl.Linux-x86_64.tar.xz
    
    - name: Rename SDK directory
      run: |
        echo "Rename SDK dir"
        mv openwrt-sdk-21.02.7-ramips-mt7621_gcc-8.4.0_musl.Linux-x86_64 openwrt-sdk
    
    - name: Modify feeds configuration
      run: |
        echo "Modified feeds.conf.default"
        sed -i 's/https:/http:/g' feeds.conf.default
    
    - name: Copy esurfingclient package to dl directory
      run: |
        echo "Copy esurfingclient package to dl dir"
        tar -czf esurfingclient.tar.gz esurfing
        mv esurfingclient.tar.gz openwrt-sdk/dl/
    
    - name: Copy esurfing package to package directory
      run: |
        echo "Copy esurfing package to package dir"
        cp -r esurfingclient openwrt-sdk/package/
    
    - name: Copy menuconfig and cover .config
      run: |
        echo "Copy menuconfig and cover .config"
        cp menuconfig.config openwrt-sdk/.config
    
    - name: Update feeds
      run: |
        echo "Go to openwrt-sdk dir"
        cd openwrt-sdk
        echo "Updating feeds"
        if scripts/feeds update -a; then
          echo "Update feeds successful"
          echo "Installing feeds packages"
          scripts/feeds install -a
        else
          echo "Update feeds failed"
          exit 1
        fi
    
    - name: Compile curl package
      run: |
        cd openwrt-sdk
        echo "Making curl package"
        make package/curl/compile V=sc -j$(nproc)
    
    - name: Compile openssl package
      run: |
        cd openwrt-sdk
        echo "Making openssl package"
        make package/openssl/compile V=sc -j$(nproc)
    
    - name: Compile esurfingclient package
      run: |
        cd openwrt-sdk
        echo "Making esurfingclient package"
        make package/esurfingclient/compile V=sc -j$(nproc)
    
    - name: Copy built package
      run: |
        echo "Copy esurfingclient package to bash dir"
        cp openwrt-sdk/bin/packages/mipsel_24kc/base/esurfingclient_1.0.0-1_mipsel_24kc.ipk esurfingclient-mipsel_24kc-openwrt-21.02.7-1.0.0.ipk
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: esurfingclient-openwrt-21.02.7-mipsel_24kc
        path: esurfingclient-mipsel_24kc-openwrt-21.02.7-1.0.0.ipk
        retention-days: 30