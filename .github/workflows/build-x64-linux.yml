name: Build x64 Linux Binary

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  actions: write
  contents: read

on:
  workflow_dispatch:
    
jobs:
  build-x64-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake gcc g++ make upx-ucl

    - name: Build ESurfingClient
      run: |
        echo "ðŸ—ï¸ Starting x64 Linux build process"
        echo "ðŸ“ Go to esurfing dir"
        cd esurfing
        
        echo "âš™ï¸ CMake configuring"
        cmake .
        
        echo "ðŸ”¨ Making Programme"
        make -j$(nproc)
        
        echo "ðŸ“¦ Moved ESurfingClient to bash dir"
        mv bin/ESurfingClient ../ESurfingClient-1.0.0
        
        echo "ðŸ›¡ï¸ Protect1 - Strip symbols"
        strip --strip-all ../ESurfingClient-1.0.0
        
        echo "ðŸ“¦ Protect2 - UPX compression"
        upx --best ../ESurfingClient-1.0.0
        
        echo "âœ… Build completed successfully"

    - name: Verify build output
      run: |
        echo "ðŸ” Verifying build output"
        if [ -f "ESurfingClient-1.0.0" ]; then
          echo "âœ… ESurfingClient binary found"
          ls -la ESurfingClient-1.0.0
          file ESurfingClient-1.0.0
          echo "ðŸ“Š Binary size: $(du -h ESurfingClient-1.0.0 | cut -f1)"
        else
          echo "âŒ ESurfingClient binary not found"
          exit 1
        fi

    - name: Create release package
      run: |
        echo "ðŸ“¦ Creating release package"
        mkdir -p release-package
        cp ESurfingClient-1.0.0 release-package/
        
        # Create README for the package
        cat > release-package/README.md << 'EOF'
# ESurfingClient x64 Linux Binary

## ç³»ç»Ÿè¦æ±‚
- Linux x86_64 ç³»ç»Ÿ
- glibc 2.17 æˆ–æ›´é«˜ç‰ˆæœ¬

## å®‰è£…è¯´æ˜Ž
1. ä¸‹è½½ ESurfingClient-1.0.0 äºŒè¿›åˆ¶æ–‡ä»¶
2. ç»™äºˆæ‰§è¡Œæƒé™ï¼š`chmod +x ESurfingClient-1.0.0`
3. è¿è¡Œç¨‹åºï¼š`./ESurfingClient-1.0.0`

## ä½¿ç”¨è¯´æ˜Ž
è¯·å‚è€ƒé¡¹ç›®ä¸»é¡µçš„ä½¿ç”¨æ–‡æ¡£ã€‚

## æž„å»ºä¿¡æ¯
- æž„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
- æž„å»ºå¹³å°: x86_64 Linux
- ç¼–è¯‘å™¨: GCC $(gcc --version | head -n1)
- ä¼˜åŒ–: å·²å¯ç”¨ç¬¦å·å‰¥ç¦»å’Œ UPX åŽ‹ç¼©
EOF
        
        # Create version info
        cat > release-package/version.txt << EOF
Version: 1.0.0
Platform: x86_64-linux
Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
Build ID: ${{ github.run_id }}
Commit: ${{ github.sha }}
EOF
        
        echo "ðŸ“‹ Package contents:"
        ls -la release-package/

    - name: Create compressed archive
      run: |
        echo "ðŸ—œï¸ Creating compressed archive"
        cd release-package
        tar -czf ../esurfingclient-x64-linux.tar.gz *
        cd ..
        
        echo "ðŸ“Š Archive info:"
        ls -la esurfingclient-x64-linux.tar.gz
        echo "ðŸ“¦ Archive size: $(du -h esurfingclient-x64-linux.tar.gz | cut -f1)"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: esurfingclient-x64-linux
        path: |
          esurfingclient-x64-linux.tar.gz
          ESurfingClient-1.0.0
        retention-days: 30

    - name: Build summary
      run: |
        echo "## ðŸŽ‰ x64 Linux Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Build Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **Binary**: ESurfingClient-1.0.0" >> $GITHUB_STEP_SUMMARY
        echo "- **Archive**: esurfingclient-x64-linux.tar.gz" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform**: x86_64 Linux" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Binary Size**: $(du -h ESurfingClient-1.0.0 | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- **Archive Size**: $(du -h esurfingclient-x64-linux.tar.gz | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ› ï¸ Optimizations Applied" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Symbol stripping (strip --strip-all)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… UPX compression (--best)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Ready for deployment!**" >> $GITHUB_STEP_SUMMARY