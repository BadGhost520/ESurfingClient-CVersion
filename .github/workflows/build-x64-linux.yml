name: Build x64 Linux Binary

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  actions: write
  contents: read

on:
  workflow_dispatch:
    
jobs:
  build-x64-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake gcc g++ make upx-ucl binutils libcurl4-openssl-dev libssl-dev

    - name: Build ESurfingClient
      run: |
        echo "ðŸ—ï¸ Starting x64 Linux build process"
        echo "ðŸ“ Go to esurfing dir"
        cd esurfing
        
        echo "âš™ï¸ CMake configuring"
        cmake .
        
        echo "ðŸ”¨ Making Programme"
        make -j$(nproc)
        
        echo "ðŸ“¦ Moved ESurfingClient to root dir"
        mv bin/ESurfingClient ../ESurfingClient-1.0.0
        
        echo "ðŸ›¡ï¸ Protect1 - Strip binary"
        strip --strip-all ../ESurfingClient-1.0.0
        
        echo "ðŸ“¦ Protect2 - Compress with UPX"
        upx --best ../ESurfingClient-1.0.0
        
        echo "âœ… Build completed successfully"

    - name: Verify build output
      run: |
        echo "ðŸ” Verifying build output"
        if [ -f "ESurfingClient-1.0.0" ]; then
          echo "âœ… Binary file exists"
          ls -la ESurfingClient-1.0.0
          file ESurfingClient-1.0.0
          echo "ðŸ“ File size: $(du -h ESurfingClient-1.0.0 | cut -f1)"
        else
          echo "âŒ Binary file not found"
          exit 1
        fi

    - name: Create package
      run: |
        echo "ðŸ“¦ Creating package"
        mkdir -p esurfingclient-x64-linux
        cp ESurfingClient-1.0.0 esurfingclient-x64-linux/
        
        # Create a simple README
        cat > esurfingclient-x64-linux/README.md << 'EOF'
        # ESurfing Client - x64 Linux Binary
        
        ## Installation
        
        1. Make the binary executable:
           ```bash
           chmod +x ESurfingClient-1.0.0
           ```
        
        2. Run the client:
           ```bash
           ./ESurfingClient-1.0.0
           ```
        
        ## System Requirements
        
        - x64 Linux system
        - Compatible with most modern Linux distributions
        
        ## Build Information
        
        - Platform: x64 Linux
        - Compiler: GCC
        - Optimizations: Stripped and compressed with UPX
        EOF
        
        # Create compressed package
        tar -czf esurfingclient-x64-linux.tar.gz esurfingclient-x64-linux/
        
        echo "ðŸ“¦ Package created: esurfingclient-x64-linux.tar.gz"
        ls -la esurfingclient-x64-linux.tar.gz

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: esurfingclient-x64-linux
        path: esurfingclient-x64-linux.tar.gz
        retention-days: 30

    - name: Build summary
      run: |
        echo "## ðŸŽ‰ Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Platform**: x64 Linux" >> $GITHUB_STEP_SUMMARY
        echo "**Binary**: ESurfingClient-1.0.0" >> $GITHUB_STEP_SUMMARY
        echo "**Package**: esurfingclient-x64-linux.tar.gz" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Build Details" >> $GITHUB_STEP_SUMMARY
        echo "- Compiler: GCC" >> $GITHUB_STEP_SUMMARY
        echo "- Optimizations: Stripped symbols, UPX compressed" >> $GITHUB_STEP_SUMMARY
        echo "- Package format: tar.gz" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifact Information" >> $GITHUB_STEP_SUMMARY
        echo "- Artifact name: \`esurfingclient-x64-linux\`" >> $GITHUB_STEP_SUMMARY
        echo "- Retention: 30 days" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ The build artifact is ready for download!"