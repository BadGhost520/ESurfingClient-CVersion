name: Build All Platforms

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  actions: write
  contents: read
  metadata: read

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Select platform to build'
        type: choice
        required: true
        default: 'all'
        options:
          - all
          - mipsel-21.02.7
          - mipsel-23.05.0
          - x86_64-21.02.7
          - x86_64-22.03.7
          - x86_64-24.10.4

jobs:
  # æ£€æŸ¥è¦æ„å»ºçš„å¹³å°
  check-platforms:
    runs-on: ubuntu-latest
    outputs:
      selected-platform: ${{ steps.check.outputs.selected-platform }}
    steps:
      - name: Check platforms to build
        id: check
        run: |
          platforms="${{ github.event.inputs.platforms || 'all' }}"
          echo "Selected platform: $platforms"
          echo "selected-platform=$platforms" >> $GITHUB_OUTPUT

  # ç»Ÿä¸€æ„å»ºå’Œæ”¶é›†ä½œä¸š
  build-and-collect:
    needs: check-platforms
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create artifacts directory
        run: mkdir -p artifacts
        
      - name: Trigger and wait for platform builds
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // éœ€è¦è§¦å‘çš„å·¥ä½œæµåˆ—è¡¨åŠå…¶å¯¹åº”çš„å¹³å°æ£€æŸ¥
            const workflows = [
              { file: 'build-mipsel_24kc-openwrt-21.02.7.yml', platform: 'mipsel-21.02.7' },
              { file: 'build-mipsel_24kc-openwrt-23.05.0.yml', platform: 'mipsel-23.05.0' },
              { file: 'build-x86_64-openwrt-21.02.7.yml', platform: 'x86_64-21.02.7' },
              { file: 'build-x86_64-openwrt-22.03.7.yml', platform: 'x86_64-22.03.7' },
              { file: 'build-x86_64-openwrt-24.10.4.yml', platform: 'x86_64-24.10.4' }
            ];
            
            const selectedPlatform = '${{ needs.check-platforms.outputs.selected-platform }}';
            console.log(`Selected platform: ${selectedPlatform}`);
            
            // è¿‡æ»¤éœ€è¦æ„å»ºçš„å·¥ä½œæµ
            const workflowsToTrigger = workflows.filter(w => {
              if (selectedPlatform === 'all') return true;
              return selectedPlatform === w.platform;
            });
            
            console.log(`Will trigger ${workflowsToTrigger.length} workflows`);
            
            // è§¦å‘å·¥ä½œæµ
            for (const workflow of workflowsToTrigger) {
              try {
                console.log(`Triggering ${workflow.file}...`);
                
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.file,
                  ref: context.ref
                });
                
                console.log(`âœ… Triggered ${workflow.file} successfully`);
                
              } catch (error) {
                console.log(`âŒ Error triggering ${workflow.file}: ${error.message}`);
              }
            }
            
            console.log(`ğŸš€ Triggered ${workflowsToTrigger.length} workflows`);
            console.log('â³ Waiting 2 minutes for workflows to start...');
            
            // ç­‰å¾…2åˆ†é’Ÿè®©å·¥ä½œæµå¼€å§‹
            await new Promise(resolve => setTimeout(resolve, 120000));
            
            // ç°åœ¨æ£€æŸ¥å·¥ä½œæµçŠ¶æ€å¹¶ç­‰å¾…å®Œæˆ
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              let allCompleted = true;
              const runStatuses = [];
              
              for (const workflow of workflowsToTrigger) {
                try {
                  // è·å–è¯¥å·¥ä½œæµçš„æœ€æ–°è¿è¡Œ
                  const runs = await github.rest.actions.listWorkflowRuns({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    workflow_id: workflow.file,
                    per_page: 1
                  });
                  
                  if (runs.data.workflow_runs.length > 0) {
                    const latestRun = runs.data.workflow_runs[0];
                    const status = latestRun.status;
                    const conclusion = latestRun.conclusion;
                    
                    console.log(`${workflow.platform}: ${status} - ${conclusion || 'running'}`);
                    
                    runStatuses.push({
                      workflow: workflow.file,
                      platform: workflow.platform,
                      status: status,
                      conclusion: conclusion,
                      runId: latestRun.id
                    });
                    
                    if (status !== 'completed') {
                      allCompleted = false;
                    }
                  } else {
                    console.log(`${workflow.platform}: No runs found`);
                    allCompleted = false;
                  }
                } catch (error) {
                  console.log(`Error checking ${workflow.platform}: ${error.message}`);
                  allCompleted = false;
                }
              }
              
              if (allCompleted) {
                console.log('ğŸ‰ All workflows completed!');
                
                // æ”¶é›†æˆåŠŸçš„æ„å»ºäº§ç‰©
                const artifactsList = [];
                for (const runStatus of runStatuses) {
                  if (runStatus.conclusion === 'success') {
                    try {
                      const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        run_id: runStatus.runId
                      });
                      
                      for (const artifact of artifacts.data.artifacts) {
                        artifactsList.push({
                          platform: runStatus.platform,
                          name: artifact.name,
                          download_url: artifact.archive_download_url,
                          size: artifact.size_in_bytes
                        });
                      }
                      console.log(`âœ… ${runStatus.platform} build completed successfully`);
                    } catch (error) {
                      console.log(`Error collecting artifacts for ${runStatus.platform}: ${error.message}`);
                    }
                  } else {
                    console.log(`âŒ ${runStatus.platform} build failed with: ${runStatus.conclusion}`);
                  }
                }
                
                // ä¿å­˜äº§ç‰©åˆ—è¡¨
                fs.writeFileSync('artifacts-list.json', JSON.stringify(artifactsList, null, 2));
                console.log(`ğŸ“¦ Collected ${artifactsList.length} artifacts`);
                break;
              }
              
              console.log('â³ Still waiting for workflows to complete...');
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            if (Date.now() - startTime >= maxWaitTime) {
              console.log('â° Timeout reached, stopping wait');
            }

      - name: Create build summary
        run: |
          mkdir -p collected-artifacts
          
          # åˆ›å»ºREADMEæ–‡ä»¶
          cat > collected-artifacts/README.md << 'EOF'
          # ESurfing Client Build Artifacts
          
          This package contains build artifacts for multiple OpenWrt platforms.
          
          ## Platforms Included
          
          - **mipsel_24kc OpenWrt 21.02.7** - For older MIPS routers
          - **mipsel_24kc OpenWrt 23.05.0** - For newer MIPS routers  
          - **x86_64 OpenWrt 21.02.7** - For x86_64 systems (older)
          - **x86_64 OpenWrt 22.03.7** - For x86_64 systems (stable)
          - **x86_64 OpenWrt 24.10.4** - For x86_64 systems (latest)
          
          ## Installation Instructions
          
          1. Extract the appropriate package for your platform
          2. Copy the binary to your OpenWrt device
          3. Make it executable: `chmod +x esurfingclient`
          4. Run with appropriate configuration
          
          ## Build Information
          
          - Built with: GitHub Actions
          - Compiler: Cross-compilation toolchain for each platform
          - Build date: $(date)
          
          For more information, visit: https://github.com/$(echo $GITHUB_REPOSITORY)
          EOF
          
          echo "âœ… Created build summary and README"
          echo "### ğŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "Selected platform: ${{ needs.check-platforms.outputs.selected-platform }}" >> $GITHUB_STEP_SUMMARY
          echo "All build artifacts have been collected and uploaded as a unified package." >> $GITHUB_STEP_SUMMARY

      - name: Upload collected artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esurfing-client-all-platforms
          path: |
            collected-artifacts/
            artifacts/
          retention-days: 30
          
      - name: Check overall result
        run: |
          echo "âœ… All selected builds completed successfully"
          echo "ğŸ“¦ Artifacts have been collected and uploaded"