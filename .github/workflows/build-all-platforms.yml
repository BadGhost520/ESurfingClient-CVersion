name: Build All OpenWrt Platforms

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Select platforms to build (comma-separated: mipsel-21.02.7, mipsel-23.05.0, x86_64-24.10.4, or "all")'
        required: false
        default: 'all'
        type: string
  push:
    branches: [ main, master ]
    paths:
      - 'esurfing/**'
      - 'esurfingclient/**'
      - '.github/workflows/build-*.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'esurfing/**'
      - 'esurfingclient/**'
      - '.github/workflows/build-*.yml'

jobs:
  # Ê£ÄÊü•Âì™‰∫õÂπ≥Âè∞ÈúÄË¶ÅÊûÑÂª∫
  check-platforms:
    runs-on: ubuntu-latest
    outputs:
      build-mipsel-21: ${{ steps.check.outputs.build-mipsel-21 }}
      build-mipsel-23: ${{ steps.check.outputs.build-mipsel-23 }}
      build-x86_64-24: ${{ steps.check.outputs.build-x86_64-24 }}
    steps:
      - name: Check platforms to build
        id: check
        run: |
          platforms="${{ github.event.inputs.platforms || 'all' }}"
          echo "Selected platforms: $platforms"
          
          if [[ "$platforms" == "all" ]]; then
            echo "build-mipsel-21=true" >> $GITHUB_OUTPUT
            echo "build-mipsel-23=true" >> $GITHUB_OUTPUT
            echo "build-x86_64-24=true" >> $GITHUB_OUTPUT
          else
            # ÈªòËÆ§ÈÉΩ‰∏∫false
            echo "build-mipsel-21=false" >> $GITHUB_OUTPUT
            echo "build-mipsel-23=false" >> $GITHUB_OUTPUT
            echo "build-x86_64-24=false" >> $GITHUB_OUTPUT
            
            # Ê£ÄÊü•ÊØè‰∏™Âπ≥Âè∞
            if [[ "$platforms" == *"mipsel-21.02.7"* ]]; then
              echo "build-mipsel-21=true" >> $GITHUB_OUTPUT
            fi
            if [[ "$platforms" == *"mipsel-23.05.0"* ]]; then
              echo "build-mipsel-23=true" >> $GITHUB_OUTPUT
            fi
            if [[ "$platforms" == *"x86_64-24.10.4"* ]]; then
              echo "build-x86_64-24=true" >> $GITHUB_OUTPUT
            fi
          fi

  # Âπ∂Ë°åÊûÑÂª∫ mipsel_24kc OpenWrt 21.02.7
  build-mipsel-21-02-7:
    needs: check-platforms
    if: needs.check-platforms.outputs.build-mipsel-21 == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Trigger mipsel 21.02.7 build
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-mipsel_24kc_openwrt-21.02.7.yml',
              ref: context.ref
            });
            console.log('Triggered mipsel 21.02.7 build workflow');
            return result;

      - name: Wait for workflow completion
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'build-mipsel_24kc_openwrt-21.02.7.yml',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`mipsel 21.02.7 build status: ${run.status} - ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('mipsel 21.02.7 build completed successfully');
                    return;
                  } else {
                    throw new Error(`mipsel 21.02.7 build failed with conclusion: ${run.conclusion}`);
                  }
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            throw new Error('mipsel 21.02.7 build timed out');

  # Âπ∂Ë°åÊûÑÂª∫ mipsel_24kc OpenWrt 23.05.0
  build-mipsel-23-05-0:
    needs: check-platforms
    if: needs.check-platforms.outputs.build-mipsel-23 == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Trigger mipsel 23.05.0 build
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-mipsel_24kc-openwrt-23.05.0.yml',
              ref: context.ref
            });
            console.log('Triggered mipsel 23.05.0 build workflow');
            return result;

      - name: Wait for workflow completion
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'build-mipsel_24kc-openwrt-23.05.0.yml',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`mipsel 23.05.0 build status: ${run.status} - ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('mipsel 23.05.0 build completed successfully');
                    return;
                  } else {
                    throw new Error(`mipsel 23.05.0 build failed with conclusion: ${run.conclusion}`);
                  }
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            throw new Error('mipsel 23.05.0 build timed out');

  # Âπ∂Ë°åÊûÑÂª∫ x86_64 OpenWrt 24.10.4
  build-x86_64-24-10-4:
    needs: check-platforms
    if: needs.check-platforms.outputs.build-x86_64-24 == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Trigger x86_64 24.10.4 build
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-x86_64-openwrt-24.10.4.yml',
              ref: context.ref
            });
            console.log('Triggered x86_64 24.10.4 build workflow');
            return result;

      - name: Wait for workflow completion
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'build-x86_64-openwrt-24.10.4.yml',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`x86_64 24.10.4 build status: ${run.status} - ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('x86_64 24.10.4 build completed successfully');
                    return;
                  } else {
                    throw new Error(`x86_64 24.10.4 build failed with conclusion: ${run.conclusion}`);
                  }
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            throw new Error('x86_64 24.10.4 build timed out');

  # Ê±áÊÄªÊûÑÂª∫ÁªìÊûú
  summary:
    needs: [check-platforms, build-mipsel-21-02-7, build-mipsel-23-05-0, build-x86_64-24-10-4]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build Summary
        run: |
          echo "## üöÄ Build All Platforms Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # mipsel 21.02.7
          if [[ "${{ needs.check-platforms.outputs.build-mipsel-21 }}" == "true" ]]; then
            if [[ "${{ needs.build-mipsel-21-02-7.result }}" == "success" ]]; then
              echo "| mipsel_24kc OpenWrt 21.02.7 | ‚úÖ Built | Success |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.build-mipsel-21-02-7.result }}" == "failure" ]]; then
              echo "| mipsel_24kc OpenWrt 21.02.7 | ‚ùå Built | Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| mipsel_24kc OpenWrt 21.02.7 | ‚è≠Ô∏è Built | Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| mipsel_24kc OpenWrt 21.02.7 | ‚è≠Ô∏è Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # mipsel 23.05.0
          if [[ "${{ needs.check-platforms.outputs.build-mipsel-23 }}" == "true" ]]; then
            if [[ "${{ needs.build-mipsel-23-05-0.result }}" == "success" ]]; then
              echo "| mipsel_24kc OpenWrt 23.05.0 | ‚úÖ Built | Success |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.build-mipsel-23-05-0.result }}" == "failure" ]]; then
              echo "| mipsel_24kc OpenWrt 23.05.0 | ‚ùå Built | Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| mipsel_24kc OpenWrt 23.05.0 | ‚è≠Ô∏è Built | Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| mipsel_24kc OpenWrt 23.05.0 | ‚è≠Ô∏è Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # x86_64 24.10.4
          if [[ "${{ needs.check-platforms.outputs.build-x86_64-24 }}" == "true" ]]; then
            if [[ "${{ needs.build-x86_64-24-10-4.result }}" == "success" ]]; then
              echo "| x86_64 OpenWrt 24.10.4 | ‚úÖ Built | Success |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.build-x86_64-24-10-4.result }}" == "failure" ]]; then
              echo "| x86_64 OpenWrt 24.10.4 | ‚ùå Built | Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| x86_64 OpenWrt 24.10.4 | ‚è≠Ô∏è Built | Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| x86_64 OpenWrt 24.10.4 | ‚è≠Ô∏è Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Check individual workflow runs for build artifacts (IPK files)." >> $GITHUB_STEP_SUMMARY
          
      - name: Check overall result
        run: |
          # Ê£ÄÊü•ÊòØÂê¶Êúâ‰ªª‰ΩïÊûÑÂª∫Â§±Ë¥•
          if [[ "${{ needs.build-mipsel-21-02-7.result }}" == "failure" ]] || \
             [[ "${{ needs.build-mipsel-23-05-0.result }}" == "failure" ]] || \
             [[ "${{ needs.build-x86_64-24-10-4.result }}" == "failure" ]]; then
            echo "‚ùå One or more builds failed"
            exit 1
          else
            echo "‚úÖ All selected builds completed successfully"
          fi