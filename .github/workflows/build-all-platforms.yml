name: Build All Platforms

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Select platform to build'
        type: choice
        required: true
        default: 'all'
        options:
          - all
          - mipsel-21.02.7
          - mipsel-23.05.0
          - x86_64-21.02.7
          - x86_64-22.03.7
          - x86_64-24.10.4

jobs:
  # æ£€æŸ¥è¦æ„å»ºçš„å¹³å°
  check-platforms:
    runs-on: ubuntu-latest
    outputs:
      selected-platform: ${{ steps.check.outputs.selected-platform }}
    steps:
      - name: Check platforms to build
        id: check
        run: |
          platforms="${{ github.event.inputs.platforms || 'all' }}"
          echo "Selected platform: $platforms"
          echo "selected-platform=$platforms" >> $GITHUB_OUTPUT

  # ç»Ÿä¸€æ„å»ºå’Œæ”¶é›†ä½œä¸š
  build-and-collect:
    needs: check-platforms
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create artifacts directory
        run: mkdir -p artifacts
        
      - name: Trigger and wait for platform builds
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // éœ€è¦è§¦å‘çš„å·¥ä½œæµåˆ—è¡¨åŠå…¶å¯¹åº”çš„å¹³å°æ£€æŸ¥
            const workflows = [
              { file: 'build-mipsel_24kc-openwrt-21.02.7.yml', platform: 'mipsel-21.02.7' },
              { file: 'build-mipsel_24kc-openwrt-23.05.0.yml', platform: 'mipsel-23.05.0' },
              { file: 'build-x86_64-openwrt-21.02.7.yml', platform: 'x86_64-21.02.7' },
              { file: 'build-x86_64-openwrt-22.03.7.yml', platform: 'x86_64-22.03.7' },
              { file: 'build-x86_64-openwrt-24.10.4.yml', platform: 'x86_64-24.10.4' }
            ];
            
            const selectedPlatform = '${{ needs.check-platforms.outputs.selected-platform }}';
            console.log(`Selected platform: ${selectedPlatform}`);
            
            // è¿‡æ»¤éœ€è¦æ„å»ºçš„å·¥ä½œæµ
            const workflowsToTrigger = workflows.filter(w => {
              if (selectedPlatform === 'all') return true;
              return selectedPlatform === w.platform;
            });
            
            console.log(`Will trigger ${workflowsToTrigger.length} workflows`);
            
            const triggeredRuns = [];
            
            // è§¦å‘å·¥ä½œæµå¹¶è®°å½•è¿è¡ŒID
            for (const workflow of workflowsToTrigger) {
              try {
                console.log(`Triggering ${workflow.file}...`);
                
                const response = await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.file,
                  ref: context.ref
                });
                
                console.log(`Triggered ${workflow.file} successfully`);
                
                // ç­‰å¾…ä¸€ä¸‹è®©è¿è¡Œå¼€å§‹
                await new Promise(resolve => setTimeout(resolve, 5000));
                
                // è·å–æœ€æ–°çš„è¿è¡ŒID
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.file,
                  per_page: 1
                });
                
                if (runs.data.workflow_runs.length > 0) {
                  const runId = runs.data.workflow_runs[0].id;
                  triggeredRuns.push({
                    workflow: workflow.file,
                    platform: workflow.platform,
                    runId: runId
                  });
                  console.log(`Recorded run ID ${runId} for ${workflow.file}`);
                }
                
              } catch (error) {
                console.log(`Error triggering ${workflow.file}: ${error.message}`);
              }
            }
            
            console.log(`Triggered ${triggeredRuns.length} workflows, now waiting for completion...`);
            
            // ç­‰å¾…æ‰€æœ‰å·¥ä½œæµå®Œæˆ
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              let allCompleted = true;
              
              for (const run of triggeredRuns) {
                if (run.completed) continue;
                
                try {
                  const runDetails = await github.rest.actions.getWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.runId
                  });
                  
                  console.log(`${run.workflow} (${run.runId}): ${runDetails.data.status} - ${runDetails.data.conclusion}`);
                  
                  if (runDetails.data.status === 'completed') {
                    run.completed = true;
                    run.conclusion = runDetails.data.conclusion;
                    console.log(`âœ… ${run.workflow} completed with ${run.conclusion}`);
                  } else {
                    allCompleted = false;
                  }
                } catch (error) {
                  console.log(`Error checking ${run.workflow}: ${error.message}`);
                  allCompleted = false;
                }
              }
              
              if (allCompleted) {
                console.log('ğŸ‰ All workflows completed!');
                break;
              }
              
              console.log('â³ Waiting for workflows to complete...');
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
            if (Date.now() - startTime >= maxWaitTime) {
              throw new Error('â° Timeout waiting for workflows to complete');
            }
            
            // æ”¶é›†artifacts
            const artifactsList = [];
            
            for (const run of triggeredRuns) {
              if (run.conclusion === 'success') {
                try {
                  const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.runId
                  });
                  
                  for (const artifact of artifacts.data.artifacts) {
                    console.log(`Found artifact: ${artifact.name} from ${run.workflow}`);
                    artifactsList.push({
                      name: artifact.name,
                      workflow: run.workflow,
                      platform: run.platform,
                      download_url: artifact.archive_download_url,
                      size: artifact.size_in_bytes
                    });
                  }
                } catch (error) {
                  console.log(`Error collecting artifacts from ${run.workflow}: ${error.message}`);
                }
              } else {
                console.log(`âš ï¸ Skipping artifacts from ${run.workflow} (${run.conclusion})`);
              }
            }
            
            // ä¿å­˜artifactsä¿¡æ¯
            fs.writeFileSync('artifacts/artifacts-list.json', JSON.stringify(artifactsList, null, 2));
            console.log(`ğŸ“¦ Collected ${artifactsList.length} artifacts total`);
            
            return { triggeredRuns, artifactsList };

      - name: Create build summary
        run: |
          mkdir -p collected-artifacts
          
          # åˆ›å»ºREADMEæ–‡ä»¶
          cat > collected-artifacts/README.md << 'EOF'
          # ESurfing Client Build Artifacts
          
          This package contains build artifacts for multiple OpenWrt platforms.
          
          ## Platforms Included
          
          - **mipsel_24kc OpenWrt 21.02.7** - For older MIPS routers
          - **mipsel_24kc OpenWrt 23.05.0** - For newer MIPS routers  
          - **x86_64 OpenWrt 21.02.7** - For x86_64 systems (older)
          - **x86_64 OpenWrt 22.03.7** - For x86_64 systems (stable)
          - **x86_64 OpenWrt 24.10.4** - For x86_64 systems (latest)
          
          ## Installation Instructions
          
          1. Extract the appropriate package for your platform
          2. Copy the binary to your OpenWrt device
          3. Make it executable: `chmod +x esurfingclient`
          4. Run with appropriate configuration
          
          ## Build Information
          
          - Built with: GitHub Actions
          - Compiler: Cross-compilation toolchain for each platform
          - Build date: $(date)
          
          For more information, visit: https://github.com/$(echo $GITHUB_REPOSITORY)
          EOF
          
          echo "âœ… Created build summary and README"
          echo "### ğŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "Selected platform: ${{ needs.check-platforms.outputs.selected-platform }}" >> $GITHUB_STEP_SUMMARY
          echo "All build artifacts have been collected and uploaded as a unified package." >> $GITHUB_STEP_SUMMARY

      - name: Upload collected artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esurfing-client-all-platforms
          path: |
            collected-artifacts/
            artifacts/
          retention-days: 30
          
      - name: Check overall result
        run: |
          echo "âœ… All selected builds completed successfully"
          echo "ğŸ“¦ Artifacts have been collected and uploaded"