name: Build All OpenWrt Platforms

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  actions: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Select platform to build'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'mipsel-21.02.7'
          - 'mipsel-23.05.0'
          - 'x86_64-21.02.7'
          - 'x86_64-22.03.7'
          - 'x86_64-24.10.4'

jobs:
  # æ£€æŸ¥å“ªäº›å¹³å°éœ€è¦æž„å»º
  check-platforms:
    runs-on: ubuntu-latest
    outputs:
      build-mipsel-21: ${{ steps.check.outputs.build-mipsel-21 }}
      build-mipsel-23: ${{ steps.check.outputs.build-mipsel-23 }}
      build-x86_64-21: ${{ steps.check.outputs.build-x86_64-21 }}
      build-x86_64-22: ${{ steps.check.outputs.build-x86_64-22 }}
      build-x86_64-24: ${{ steps.check.outputs.build-x86_64-24 }}
    steps:
      - name: Check platforms to build
        id: check
        run: |
          platforms="${{ github.event.inputs.platforms || 'all' }}"
          echo "Selected platforms: $platforms"
          
          if [[ "$platforms" == "all" ]]; then
            echo "build-mipsel-21=true" >> $GITHUB_OUTPUT
            echo "build-mipsel-23=true" >> $GITHUB_OUTPUT
            echo "build-x86_64-21=true" >> $GITHUB_OUTPUT
            echo "build-x86_64-22=true" >> $GITHUB_OUTPUT
            echo "build-x86_64-24=true" >> $GITHUB_OUTPUT
          else
            # é»˜è®¤éƒ½ä¸ºfalse
            echo "build-mipsel-21=false" >> $GITHUB_OUTPUT
            echo "build-mipsel-23=false" >> $GITHUB_OUTPUT
            echo "build-x86_64-21=false" >> $GITHUB_OUTPUT
            echo "build-x86_64-22=false" >> $GITHUB_OUTPUT
            echo "build-x86_64-24=false" >> $GITHUB_OUTPUT
            
            # æ£€æŸ¥æ¯ä¸ªå¹³å°
            if [[ "$platforms" == "mipsel-21.02.7" ]]; then
              echo "build-mipsel-21=true" >> $GITHUB_OUTPUT
            fi
            if [[ "$platforms" == "mipsel-23.05.0" ]]; then
              echo "build-mipsel-23=true" >> $GITHUB_OUTPUT
            fi
            if [[ "$platforms" == "x86_64-21.02.7" ]]; then
              echo "build-x86_64-21=true" >> $GITHUB_OUTPUT
            fi
            if [[ "$platforms" == "x86_64-22.03.7" ]]; then
              echo "build-x86_64-22=true" >> $GITHUB_OUTPUT
            fi
            if [[ "$platforms" == "x86_64-24.10.4" ]]; then
              echo "build-x86_64-24=true" >> $GITHUB_OUTPUT
            fi
          fi

  # å¹¶è¡Œæž„å»º mipsel_24kc OpenWrt 21.02.7
  build-mipsel-21-02-7:
    needs: check-platforms
    if: needs.check-platforms.outputs.build-mipsel-21 == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Trigger mipsel 21.02.7 build
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-mipsel_24kc-openwrt-21.02.7.yml',
              ref: context.ref
            });
            console.log('Triggered mipsel 21.02.7 build workflow');
            return result;

      - name: Wait for workflow completion
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'build-mipsel_24kc-openwrt-21.02.7.yml',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`mipsel 21.02.7 build status: ${run.status} - ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('mipsel 21.02.7 build completed successfully');
                    return;
                  } else {
                    throw new Error(`mipsel 21.02.7 build failed with conclusion: ${run.conclusion}`);
                  }
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            throw new Error('mipsel 21.02.7 build timed out');

  # å¹¶è¡Œæž„å»º mipsel_24kc OpenWrt 23.05.0
  build-mipsel-23-05-0:
    needs: check-platforms
    if: needs.check-platforms.outputs.build-mipsel-23 == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Trigger mipsel 23.05.0 build
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-mipsel_24kc-openwrt-23.05.0.yml',
              ref: context.ref
            });
            console.log('Triggered mipsel 23.05.0 build workflow');
            return result;

      - name: Wait for workflow completion
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'build-mipsel_24kc-openwrt-23.05.0.yml',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`mipsel 23.05.0 build status: ${run.status} - ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('mipsel 23.05.0 build completed successfully');
                    return;
                  } else {
                    throw new Error(`mipsel 23.05.0 build failed with conclusion: ${run.conclusion}`);
                  }
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            throw new Error('mipsel 23.05.0 build timed out');

  # å¹¶è¡Œæž„å»º x86_64 OpenWrt 21.02.7
  build-x86_64-21-02-7:
    needs: check-platforms
    if: needs.check-platforms.outputs.build-x86_64-21 == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Trigger x86_64 21.02.7 build
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-x86_64-openwrt-21.02.7.yml',
              ref: context.ref
            });
            console.log('Triggered x86_64 21.02.7 build workflow');
            return result;

      - name: Wait for workflow completion
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'build-x86_64-openwrt-21.02.7.yml',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`x86_64 21.02.7 build status: ${run.status} - ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('x86_64 21.02.7 build completed successfully');
                    return;
                  } else {
                    throw new Error(`x86_64 21.02.7 build failed with conclusion: ${run.conclusion}`);
                  }
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            throw new Error('x86_64 21.02.7 build timed out');

  # å¹¶è¡Œæž„å»º x86_64 OpenWrt 22.03.7
  build-x86_64-22-03-7:
    needs: check-platforms
    if: needs.check-platforms.outputs.build-x86_64-22 == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Trigger x86_64 22.03.7 build
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-x86_64-openwrt-22.03.7.yml',
              ref: context.ref
            });
            console.log('Triggered x86_64 22.03.7 build workflow');
            return result;

      - name: Wait for workflow completion
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'build-x86_64-openwrt-22.03.7.yml',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`x86_64 22.03.7 build status: ${run.status} - ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('x86_64 22.03.7 build completed successfully');
                    return;
                  } else {
                    throw new Error(`x86_64 22.03.7 build failed with conclusion: ${run.conclusion}`);
                  }
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            throw new Error('x86_64 22.03.7 build timed out');

  # å¹¶è¡Œæž„å»º x86_64 OpenWrt 24.10.4
  build-x86_64-24-10-4:
    needs: check-platforms
    if: needs.check-platforms.outputs.build-x86_64-24 == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Trigger x86_64 24.10.4 build
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-x86_64-openwrt-24.10.4.yml',
              ref: context.ref
            });
            console.log('Triggered x86_64 24.10.4 build workflow');
            return result;

      - name: Wait for workflow completion
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 1 hour
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'build-x86_64-openwrt-24.10.4.yml',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`x86_64 24.10.4 build status: ${run.status} - ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('x86_64 24.10.4 build completed successfully');
                    return;
                  } else {
                    throw new Error(`x86_64 24.10.4 build failed with conclusion: ${run.conclusion}`);
                  }
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            throw new Error('x86_64 24.10.4 build timed out');

  # æ±‡æ€»æž„å»ºç»“æžœ
  summary:
    needs: [check-platforms, build-mipsel-21-02-7, build-mipsel-23-05-0, build-x86_64-21-02-7, build-x86_64-22-03-7, build-x86_64-24-10-4]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ Build All Platforms Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # mipsel 21.02.7
          if [[ "${{ needs.check-platforms.outputs.build-mipsel-21 }}" == "true" ]]; then
            if [[ "${{ needs.build-mipsel-21-02-7.result }}" == "success" ]]; then
              echo "| mipsel_24kc OpenWrt 21.02.7 | âœ… Built | Success |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.build-mipsel-21-02-7.result }}" == "failure" ]]; then
              echo "| mipsel_24kc OpenWrt 21.02.7 | âŒ Built | Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| mipsel_24kc OpenWrt 21.02.7 | â­ï¸ Built | Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| mipsel_24kc OpenWrt 21.02.7 | â­ï¸ Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # mipsel 23.05.0
          if [[ "${{ needs.check-platforms.outputs.build-mipsel-23 }}" == "true" ]]; then
            if [[ "${{ needs.build-mipsel-23-05-0.result }}" == "success" ]]; then
              echo "| mipsel_24kc OpenWrt 23.05.0 | âœ… Built | Success |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.build-mipsel-23-05-0.result }}" == "failure" ]]; then
              echo "| mipsel_24kc OpenWrt 23.05.0 | âŒ Built | Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| mipsel_24kc OpenWrt 23.05.0 | â­ï¸ Built | Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| mipsel_24kc OpenWrt 23.05.0 | â­ï¸ Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # x86_64 21.02.7
          if [[ "${{ needs.check-platforms.outputs.build-x86_64-21 }}" == "true" ]]; then
            if [[ "${{ needs.build-x86_64-21-02-7.result }}" == "success" ]]; then
              echo "| x86_64 OpenWrt 21.02.7 | âœ… Built | Success |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.build-x86_64-21-02-7.result }}" == "failure" ]]; then
              echo "| x86_64 OpenWrt 21.02.7 | âŒ Built | Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| x86_64 OpenWrt 21.02.7 | â­ï¸ Built | Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| x86_64 OpenWrt 21.02.7 | â­ï¸ Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # x86_64 22.03.7
          if [[ "${{ needs.check-platforms.outputs.build-x86_64-22 }}" == "true" ]]; then
            if [[ "${{ needs.build-x86_64-22-03-7.result }}" == "success" ]]; then
              echo "| x86_64 OpenWrt 22.03.7 | âœ… Built | Success |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.build-x86_64-22-03-7.result }}" == "failure" ]]; then
              echo "| x86_64 OpenWrt 22.03.7 | âŒ Built | Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| x86_64 OpenWrt 22.03.7 | â­ï¸ Built | Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| x86_64 OpenWrt 22.03.7 | â­ï¸ Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # x86_64 24.10.4
          if [[ "${{ needs.check-platforms.outputs.build-x86_64-24 }}" == "true" ]]; then
            if [[ "${{ needs.build-x86_64-24-10-4.result }}" == "success" ]]; then
              echo "| x86_64 OpenWrt 24.10.4 | âœ… Built | Success |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.build-x86_64-24-10-4.result }}" == "failure" ]]; then
              echo "| x86_64 OpenWrt 24.10.4 | âŒ Built | Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| x86_64 OpenWrt 24.10.4 | â­ï¸ Built | Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| x86_64 OpenWrt 24.10.4 | â­ï¸ Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "All build artifacts have been collected and uploaded as a unified package." >> $GITHUB_STEP_SUMMARY
          
      - name: Collect build artifacts
        if: success() || failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // åˆ›å»ºartifactsç›®å½•
            if (!fs.existsSync('artifacts')) {
              fs.mkdirSync('artifacts', { recursive: true });
            }
            
            // èŽ·å–æ‰€æœ‰å·¥ä½œæµè¿è¡Œ
            const workflows = [
              'build-mipsel_24kc_openwrt-21.02.7.yml',
              'build-mipsel_24kc-openwrt-23.05.0.yml', 
              'build-x86_64-openwrt-21.02.7.yml',
              'build-x86_64-openwrt-22.03.7.yml',
              'build-x86_64-openwrt-24.10.4.yml'
            ];
            
            const artifactsList = [];
            
            for (const workflow of workflows) {
              try {
                // èŽ·å–æœ€è¿‘çš„å·¥ä½œæµè¿è¡Œ
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow,
                  per_page: 1,
                  status: 'completed'
                });
                
                if (runs.data.workflow_runs.length > 0) {
                  const run = runs.data.workflow_runs[0];
                  console.log(`Found run for ${workflow}: ${run.id}`);
                  
                  // èŽ·å–è¯¥è¿è¡Œçš„artifacts
                  const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                  
                  for (const artifact of artifacts.data.artifacts) {
                    console.log(`Found artifact: ${artifact.name}`);
                    artifactsList.push({
                      name: artifact.name,
                      workflow: workflow,
                      download_url: artifact.archive_download_url,
                      size: artifact.size_in_bytes
                    });
                  }
                }
              } catch (error) {
                console.log(`Error processing ${workflow}: ${error.message}`);
              }
            }
            
            // ä¿å­˜artifactsä¿¡æ¯
            fs.writeFileSync('artifacts/artifacts-list.json', JSON.stringify(artifactsList, null, 2));
            console.log(`Found ${artifactsList.length} artifacts total`);
            
            return artifactsList;

      - name: Download and collect artifacts
        if: success() || failure()
        run: |
          mkdir -p collected-artifacts
          
          # åˆ›å»ºREADMEæ–‡ä»¶
          cat > collected-artifacts/README.md << 'EOF'
          # ESurfing Client Build Artifacts
          
          This package contains build artifacts for multiple OpenWrt platforms.
          
          ## Platforms Included
          
          - **mipsel_24kc OpenWrt 21.02.7** - For older MIPS routers
          - **mipsel_24kc OpenWrt 23.05.0** - For newer MIPS routers  
          - **x86_64 OpenWrt 21.02.7** - For x86_64 systems (older)
          - **x86_64 OpenWrt 22.03.7** - For x86_64 systems (stable)
          - **x86_64 OpenWrt 24.10.4** - For x86_64 systems (latest)
          
          ## Installation
          
          1. Copy the appropriate IPK file to your OpenWrt device
          2. Install using: `opkg install esurfingclient_*.ipk`
          3. Configure using: `uci set esurfingclient.config.username=your_username`
          4. Start service: `/etc/init.d/esurfingclient start`
          
          ## Build Information
          
          - Build Date: $(date)
          - Repository: ${{ github.repository }}
          - Commit: ${{ github.sha }}
          - Workflow Run: ${{ github.run_id }}
          EOF
          
          echo "âœ… Created artifacts collection directory"

      - name: Upload collected artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: esurfing-client-all-platforms
          path: |
            collected-artifacts/
            artifacts/
          retention-days: 30
          
      - name: Check overall result
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æž„å»ºå¤±è´¥
          if [[ "${{ needs.build-mipsel-21-02-7.result }}" == "failure" ]] || \
             [[ "${{ needs.build-mipsel-23-05-0.result }}" == "failure" ]] || \
             [[ "${{ needs.build-x86_64-21-02-7.result }}" == "failure" ]] || \
             [[ "${{ needs.build-x86_64-22-03-7.result }}" == "failure" ]] || \
             [[ "${{ needs.build-x86_64-24-10-4.result }}" == "failure" ]]; then
            echo "âŒ One or more builds failed"
            exit 1
          else
            echo "âœ… All selected builds completed successfully"
          fi