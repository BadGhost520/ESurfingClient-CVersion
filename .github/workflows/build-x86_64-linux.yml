name: Build x86_64 Linux Binary

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  actions: write
  contents: read

on:
  workflow_dispatch:
    
jobs:
  build-x64-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake gcc g++ make upx-ucl binutils libcurl4-openssl-dev libssl-dev libnghttp2-dev libz-dev libzstd-dev libbrotli-dev libkrb5-dev libidn2-dev libssh2-1-dev libpsl-dev

    - name: Build ESurfingClient
      run: |
        echo "ğŸ—ï¸ Starting x64 Linux build process"
        echo "ğŸ“ Go to esurfing dir"
        cd esurfing
        
        echo "âš™ï¸ CMake configuring with static linking"
        cmake . -DCMAKE_EXE_LINKER_FLAGS="-static" -DCMAKE_FIND_LIBRARY_SUFFIXES=".a"
        
        echo "ğŸ”¨ Making Programme"
        make -j$(nproc)
        
        echo "ğŸ“¦ Moved ESurfingClient to root dir"
        mv bin/ESurfingClient ../ESurfingClient-x86_64-linux
        
        echo "ğŸ›¡ï¸ Protect1 - Strip binary"
        strip --strip-all ../ESurfingClient-x86_64-linux
        
        echo "ğŸ“¦ Protect2 - Compress with UPX"
        upx --best ../ESurfingClient-x86_64-linux
        
        echo "âœ… Build completed successfully"

    - name: Verify build output
      run: |
        echo "ğŸ” Verifying build output"
        if [ -f "ESurfingClient-x86_64-linux" ]; then
          echo "âœ… Binary file exists"
          ls -la ESurfingClient-x86_64-linux
          file ESurfingClient-x86_64-linux
          echo "ğŸ“ File size: $(du -h ESurfingClient-x86_64-linux | cut -f1)"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€é“¾æ¥
          if ldd ESurfingClient-x86_64-linux 2>&1 | grep -q "not a dynamic executable"; then
            echo "âœ… Confirmed: Binary is statically linked"
          else
            echo "âš ï¸  Warning: Binary appears to be dynamically linked"
            ldd ESurfingClient-x86_64-linux
          fi
        else
          echo "âŒ Binary file not found"
          exit 1
        fi

    - name: Create package
      run: |
        echo "ğŸ“¦ Creating package"
        
        # Create compressed package with executable in root
        tar -czf esurfingclient-x64-linux.tar.gz ESurfingClient-x86_64-linux
        
        echo "ğŸ“¦ Package created: esurfingclient-x64-linux.tar.gz"
        ls -la esurfingclient-x64-linux.tar.gz

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: esurfingclient-x64-linux
        path: |
          ESurfingClient-x86_64-linux
        retention-days: 30