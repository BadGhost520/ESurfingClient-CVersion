name: Build x86_64 Windows Binary

# ÈÖçÁΩÆÂ∑•‰ΩúÊµÅÊùÉÈôê
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:

jobs:
  build-x64-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-make
          mingw-w64-x86_64-curl
          mingw-w64-x86_64-openssl
          mingw-w64-x86_64-libxml2
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-upx

    - name: Build ESurfingClient
      shell: msys2 {0}
      run: |
        echo "üèóÔ∏è Starting Windows x64 build process"
        
        echo "üìÅ Go to esurfing dir"
        cd esurfing
        
        echo "‚öôÔ∏è CMake configuring with static linking"
        cmake -G "MinGW Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER=gcc \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_EXE_LINKER_FLAGS="-static -static-libgcc -static-libstdc++" \
          -DCMAKE_FIND_LIBRARY_SUFFIXES=".a" \
          -DBUILD_SHARED_LIBS=OFF \
          .
        
        echo "üî® Building with mingw32-make"
        mingw32-make -j$(nproc)
        
        echo "üì¶ Moving and renaming executable"
        if [ -f "ESurfingClient.exe" ]; then
          mv ESurfingClient.exe ESurfingClient-x86_64-windows.exe
          echo "‚úÖ Executable renamed to ESurfingClient-x86_64-windows.exe"
        else
          echo "‚ùå ESurfingClient.exe not found!"
          exit 1
        fi
        
        echo "üóúÔ∏è Compressing with UPX"
        upx --best --lzma ESurfingClient-x86_64-windows.exe || echo "‚ö†Ô∏è UPX compression failed, continuing..."
        
        echo "üìä File information:"
        ls -la ESurfingClient-x86_64-windows.exe
        file ESurfingClient-x86_64-windows.exe || echo "file command not available"

    - name: Verify build output
      shell: msys2 {0}
      run: |
        cd esurfing
        if [ ! -f "ESurfingClient-x86_64-windows.exe" ]; then
          echo "‚ùå Build failed: ESurfingClient-x86_64-windows.exe not found"
          exit 1
        fi
        
        echo "‚úÖ Build successful!"
        echo "üìÅ Final executable: $(pwd)/ESurfingClient-x86_64-windows.exe"
        echo "üìè File size: $(stat -c%s ESurfingClient-x86_64-windows.exe) bytes"

    - name: Create package
      shell: msys2 {0}
      run: |
        echo "üì¶ Creating Windows x64 package"
        
        # Copy executable to root directory for packaging
        cp esurfing/ESurfingClient-x86_64-windows.exe ./
        
        # Create ZIP archive with executable in root
        echo "üóúÔ∏è Creating ZIP archive"
        7z a esurfingclient-windows-x64.zip ESurfingClient-x86_64-windows.exe

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: esurfingclient-windows-x64
        path: |
          esurfingclient-windows-x64.zip
          ESurfingClient-x86_64-windows.exe
        retention-days: 30