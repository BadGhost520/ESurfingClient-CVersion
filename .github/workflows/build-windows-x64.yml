name: Build Windows x64 Binary

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-make
          mingw-w64-x86_64-curl
          mingw-w64-x86_64-openssl
          mingw-w64-x86_64-libxml2
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-upx

    - name: Build ESurfingClient
      shell: msys2 {0}
      run: |
        echo "ðŸ—ï¸ Starting Windows x64 build process"
        
        echo "ðŸ“ Go to esurfing dir"
        cd esurfing
        
        echo "âš™ï¸ CMake configuring with static linking"
        cmake -G "MinGW Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER=gcc \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_EXE_LINKER_FLAGS="-static -static-libgcc -static-libstdc++" \
          -DCMAKE_FIND_LIBRARY_SUFFIXES=".a" \
          -DBUILD_SHARED_LIBS=OFF \
          .
        
        echo "ðŸ”¨ Building with make"
        make -j$(nproc)
        
        echo "ðŸ“¦ Moving and renaming executable"
        if [ -f "ESurfingClient.exe" ]; then
          mv ESurfingClient.exe ESurfingClient-1.0.0.exe
          echo "âœ… Executable renamed to ESurfingClient-1.0.0.exe"
        else
          echo "âŒ ESurfingClient.exe not found!"
          exit 1
        fi
        
        echo "ðŸ—œï¸ Compressing with UPX"
        upx --best --lzma ESurfingClient-1.0.0.exe || echo "âš ï¸ UPX compression failed, continuing..."
        
        echo "ðŸ“Š File information:"
        ls -la ESurfingClient-1.0.0.exe
        file ESurfingClient-1.0.0.exe || echo "file command not available"

    - name: Verify build output
      shell: msys2 {0}
      run: |
        cd esurfing
        if [ ! -f "ESurfingClient-1.0.0.exe" ]; then
          echo "âŒ Build failed: ESurfingClient-1.0.0.exe not found"
          exit 1
        fi
        
        echo "âœ… Build successful!"
        echo "ðŸ“ Final executable: $(pwd)/ESurfingClient-1.0.0.exe"
        echo "ðŸ“ File size: $(stat -c%s ESurfingClient-1.0.0.exe) bytes"

    - name: Create package
      shell: msys2 {0}
      run: |
        echo "ðŸ“¦ Creating Windows x64 package"
        
        # Create package directory
        mkdir -p esurfingclient-windows-x64
        
        # Copy executable
        cp esurfing/ESurfingClient-1.0.0.exe esurfingclient-windows-x64/
        
        # Create README
        cat > esurfingclient-windows-x64/README.txt << 'EOF'
ESurfingClient Windows x64 Binary
================================

This is a statically linked Windows x64 binary of ESurfingClient.

Files:
- ESurfingClient-1.0.0.exe: Main executable (statically linked)

Usage:
  ESurfingClient-1.0.0.exe [options]

Build Information:
- Platform: Windows x64
- Compiler: MinGW-w64 GCC
- Linking: Static (no external DLL dependencies)
- Compression: UPX compressed
- Build Date: $(date)

For more information, visit the project repository.
EOF
        
        echo "ðŸ“‹ Package contents:"
        ls -la esurfingclient-windows-x64/
        
        echo "ðŸ—œï¸ Creating ZIP archive"
        7z a esurfingclient-windows-x64.zip esurfingclient-windows-x64/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: esurfingclient-windows-x64
        path: |
          esurfingclient-windows-x64.zip
          esurfing/ESurfingClient-1.0.0.exe
        retention-days: 30

    - name: Generate build summary
      shell: msys2 {0}
      run: |
        echo "## ðŸ—ï¸ Windows x64 Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Build Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts Generated:" >> $GITHUB_STEP_SUMMARY
        echo "- \`esurfingclient-windows-x64.zip\` - Complete package with README" >> $GITHUB_STEP_SUMMARY
        echo "- \`ESurfingClient-1.0.0.exe\` - Standalone executable" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Build Configuration:" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform**: Windows x64" >> $GITHUB_STEP_SUMMARY
        echo "- **Compiler**: MinGW-w64 GCC" >> $GITHUB_STEP_SUMMARY
        echo "- **Linking**: Static (no external dependencies)" >> $GITHUB_STEP_SUMMARY
        echo "- **Compression**: UPX compressed" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type**: Release" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“š Dependencies (statically linked):" >> $GITHUB_STEP_SUMMARY
        echo "- libcurl" >> $GITHUB_STEP_SUMMARY
        echo "- OpenSSL" >> $GITHUB_STEP_SUMMARY
        echo "- LibXml2" >> $GITHUB_STEP_SUMMARY
        echo "- Windows system libraries" >> $GITHUB_STEP_SUMMARY