name: Build Windows x64 Binary

# ÈÖçÁΩÆÂ∑•‰ΩúÊµÅÊùÉÈôê
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64 upx-ucl
        
        # ÂÆâË£Ö MinGW-w64 ÁöÑÂºÄÂèëÂ∫ì
        sudo apt-get install -y \
          mingw-w64-tools \
          libz-mingw-w64-dev \
          pkg-config

    - name: Install Windows dependencies
      run: |
        # ÂàõÂª∫Â∑•‰ΩúÁõÆÂΩï
        mkdir -p /tmp/win-deps
        cd /tmp/win-deps
        
        # ËÆæÁΩÆ MinGW ÂâçÁºÄ
        export MINGW_PREFIX=/usr/x86_64-w64-mingw32
        
        # ‰∏ãËΩΩÂπ∂ÁºñËØë OpenSSL
        echo "üì¶ Building OpenSSL for Windows..."
        wget -q https://github.com/openssl/openssl/archive/refs/tags/openssl-3.2.0.tar.gz
        tar -xzf openssl-3.2.0.tar.gz
        cd openssl-openssl-3.2.0
        
        ./Configure mingw64 --cross-compile-prefix=x86_64-w64-mingw32- \
          --prefix=$MINGW_PREFIX \
          --openssldir=$MINGW_PREFIX/ssl \
          no-shared
        make -j$(nproc)
        sudo make install_sw
        cd ..
        
        # ‰∏ãËΩΩÂπ∂ÁºñËØë libxml2
        echo "üì¶ Building libxml2 for Windows..."
        wget -q https://download.gnome.org/sources/libxml2/2.12/libxml2-2.12.3.tar.xz
        tar -xf libxml2-2.12.3.tar.xz
        cd libxml2-2.12.3
        
        ./configure --host=x86_64-w64-mingw32 \
          --prefix=$MINGW_PREFIX \
          --enable-static \
          --disable-shared \
          --without-python
        make -j$(nproc)
        sudo make install
        cd ..
        
        # ‰∏ãËΩΩÂπ∂ÁºñËØë CURL
        echo "üì¶ Building CURL for Windows..."
        wget -q https://curl.se/download/curl-8.5.0.tar.gz
        tar -xzf curl-8.5.0.tar.gz
        cd curl-8.5.0
        
        ./configure --host=x86_64-w64-mingw32 \
          --prefix=$MINGW_PREFIX \
          --enable-static \
          --disable-shared \
          --with-openssl=$MINGW_PREFIX \
          --without-libpsl \
          --without-brotli \
          --without-zstd \
          --disable-ldap \
          --disable-ldaps
        make -j$(nproc)
        sudo make install

    - name: Build ESurfingClient
      run: |
        echo "üèóÔ∏è Starting Windows x64 build process"
        
        echo "üìÅ Go to esurfing dir"
        cd esurfing
        
        # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
        export MINGW_PREFIX=/usr/x86_64-w64-mingw32
        export PKG_CONFIG_PATH=$MINGW_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH
        export CMAKE_PREFIX_PATH=$MINGW_PREFIX:$CMAKE_PREFIX_PATH
        
        echo "‚öôÔ∏è CMake configuring with MinGW cross-compilation"
        cmake -G "Unix Makefiles" \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \
          -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH=$MINGW_PREFIX \
          -DCMAKE_FIND_ROOT_PATH=$MINGW_PREFIX \
          -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
          -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
          -DCMAKE_EXE_LINKER_FLAGS="-static -static-libgcc -static-libstdc++" \
          -DCMAKE_FIND_LIBRARY_SUFFIXES=".a" \
          -DBUILD_SHARED_LIBS=OFF \
          -DCURL_LIBRARY=$MINGW_PREFIX/lib/libcurl.a \
          -DCURL_INCLUDE_DIR=$MINGW_PREFIX/include \
          -DOPENSSL_ROOT_DIR=$MINGW_PREFIX \
          -DOPENSSL_LIBRARIES="$MINGW_PREFIX/lib/libssl.a;$MINGW_PREFIX/lib/libcrypto.a" \
          -DOPENSSL_INCLUDE_DIR=$MINGW_PREFIX/include \
          -DLibXml2_LIBRARY=$MINGW_PREFIX/lib/libxml2.a \
          -DLibXml2_INCLUDE_DIR=$MINGW_PREFIX/include/libxml2 \
          .
        
        echo "üî® Building with make"
        make -j$(nproc)
        
        echo "üì¶ Moving and renaming executable"
        if [ -f "ESurfingClient.exe" ]; then
          mv ESurfingClient.exe ESurfingClient-1.0.0.exe
          echo "‚úÖ Executable renamed to ESurfingClient-1.0.0.exe"
        else
          echo "‚ùå ESurfingClient.exe not found!"
          exit 1
        fi
        
        echo "üóúÔ∏è Compressing with UPX"
        upx --best --lzma ESurfingClient-1.0.0.exe || echo "‚ö†Ô∏è UPX compression failed, continuing..."
        
        echo "üìä File information:"
        ls -la ESurfingClient-1.0.0.exe
        file ESurfingClient-1.0.0.exe

    - name: Verify build output
      run: |
        cd esurfing
        if [ ! -f "ESurfingClient-1.0.0.exe" ]; then
          echo "‚ùå Build failed: ESurfingClient-1.0.0.exe not found"
          exit 1
        fi
        
        echo "‚úÖ Build successful!"
        echo "üìÅ Final executable: $(pwd)/ESurfingClient-1.0.0.exe"
        echo "üìè File size: $(stat -c%s ESurfingClient-1.0.0.exe) bytes"

    - name: Create package
      run: |
        echo "üì¶ Creating Windows x64 package"
        
        # Create package directory
        mkdir -p esurfingclient-windows-x64
        
        # Copy executable
        cp esurfing/ESurfingClient-1.0.0.exe esurfingclient-windows-x64/